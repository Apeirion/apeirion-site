name: Deploy to Proxmox VM via Tailscale

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies and build (Vite)
        run: |
          npm ci
          npm run build

      - name: Compress build
        run: |
          tar -czf site.tar.gz dist/ nginx.conf Dockerfile

      - name: Install and connect Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey $TAILSCALE_AUTH_KEY
          echo "Tailscale IP: $(tailscale ip -4)"  # for debug

      - name: Upload site to VM
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          rsync -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
            -avz site.tar.gz andrew@$TAILSCALE_IP:/home/andrew/

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa andrew@$TAILSCALE_IP << 'EOF'
            cd /home/andrew
            rm -rf dist nginx.conf Dockerfile
            tar -xzf site.tar.gz
            docker build -t apeirion-site .
            docker stop apeirion-container || true
            docker rm apeirion-container || true
            docker run -d --name apeirion-container -p 80:80 apeirion-site
          EOF
