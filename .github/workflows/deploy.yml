name: Deploy to VPS on Push to Main

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared

      - name: Configure SSH
        run: |
          mkdir -p ~/.cloudflared
          echo "${{ secrets.CF_ACCESS_CLIENT_ID }}" > ~/.cloudflared/access_client_id
          echo "${{ secrets.CF_ACCESS_CLIENT_SECRET }}" > ~/.cloudflared/access_client_secret

          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          echo -e "Host ssh.apeirion.com\n  ProxyCommand cloudflared access ssh --hostname %h\n  User ${{ secrets.VPS_USER }}\n  IdentityFile ~/.ssh/id_ed25519\n  IdentitiesOnly yes\n  StrictHostKeyChecking no" > ~/.ssh/config

      - name: Copy files to VPS (via Cloudflare Tunnel)
        run: |
          scp -r . ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/apeirion/apeirion-site

      - name: SSH + Rebuild and Restart Docker
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<'EOF'
            cd ~/apeirion-site
            docker build -t apeirion/site .
            docker stop apeirion-site || true
            docker rm apeirion-site || true
            docker run -d --name apeirion-site -p 3000:80 apeirion/site
          EOF

    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
